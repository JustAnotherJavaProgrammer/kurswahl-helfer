(()=>{(function(c){"use strict";var l={};Object.defineProperty(l,"__esModule",{value:!0});var d=function(){function t(e){this.value=e}return t}(),m=function(){function t(e){this.input=e,this.pristine=!0,this.nodes=this.initializeNodes(e),this.head=this.nodes[0],e.length>1&&(this.i=this.nodes[this.nodes.length-2]),this.afteri=this.nodes[this.nodes.length-1]}return t.prototype.hasNext=function(){return this.pristine||this.afteri.next!==void 0||this.afteri.value<this.head.value},t.prototype.next=function(){if(!this.hasNext())throw"No more permutations available.";if(this.pristine)return this.visit(this.head);var e;this.afteri.next!==void 0&&this.i.value>=this.afteri.next.value?e=this.afteri:e=this.i;var n=e.next;return e.next=n.next,n.next=this.head,n.value<this.head.value&&(this.i=n),this.afteri=this.i.next,this.head=n,this.visit(this.head)},t.prototype.visit=function(e){var n=new Array;for(n.push(e.value);e.next!==void 0;)e=e.next,n.push(e.value);return this.pristine=!1,n},t.prototype.initializeNodes=function(e){for(var n=e.sort().reverse().map(function(i){return new d(i)}),s=0;s<n.length-1;s++)n[s].next=n[s+1];return n},t}(),v=l.default=m;function f(t){console.debug(t);{const s=new Set;for(const i of t.courses)if(i.choices[0].length>=i.minCapacity&&i.choices[0].length<=i.maxCapacity){i.assigned=i.choices[0];for(const r of i.assigned)s.add(r),t.people[r].assignedCourse=i.name}y(t,s),s.clear()}const e={rawData:t.rawData,courses:t.courses.map(s=>s.name),people:t.people.map(s=>({rawData:s.rawData}))},n=w(t);if(n.students.length>0){let s=S(t,n);s=M(t.courses,s,t.people.length),e.assignments=s}else e.assignments=[{quality:{gotChoice:[t.people.length],avg:0},courseAssignments:t.courses.map(s=>s.assigned??[])}];return e}function y(t,e){for(const n of t.courses)if(!n.assigned)for(const s of n.choices)for(let i=0;i<s.length;i++)e.has(s[i])&&(j(s,i),i--);return t}function C(t){return t.filter(e=>e.choices[0].length>e.maxCapacity).map(e=>t.findIndex(n=>n.name==e.name))}function x(t){return t.filter(e=>e.choices[0].length<e.minCapacity).map(e=>t.findIndex(n=>n.name==e.name))}function w(t){const e=C(t.courses),n=x(t.courses),s=t.people.map((o,u)=>o.assignedCourse?-1:u).filter(o=>o!=-1),i=s.length,r=t.courses.map((o,u)=>e.includes(u)?[o.maxCapacity]:n.includes(u)?i<o.minCapacity?[0]:[0,...g(o.minCapacity,Math.min(o.maxCapacity+1,i+1))]:g(0,Math.min(o.maxCapacity+1-o.assigned.length,i+1)));return{sum:i,legalSizes:r,students:s}}function S(t,e){let n=0n;const s=[null,null,null];for(const i of A(e))for(const r of q(i,e.students)){const o={courseAssignments:r,quality:I(r,t,e.students.length)};if(s[0]==null)s[0]=[o];else{const u=N(s[0][0].quality,o.quality);u>0?s[0]=[o]:u==0&&s[0].push(o)}if(s[1]==null)s[1]=[o];else{const u=z(s[1][0].quality,o.quality);u>0?s[1]=[o]:u==0&&s[1].push(o)}if(s[2]==null)s[2]=[o];else{const u=b(s[2][0].quality,o.quality);u>0?s[2]=[o]:u==0&&s[2].push(o)}n++,self.document||postMessage({type:1,counter:n})}return s.flat(2).filter((i,r,o)=>r==o.indexOf(i))}function*A(t){const e=t.legalSizes.map(a);do{const n=T(e,t.legalSizes);n.reduce(O,0)==t.sum&&(yield n);for(let i=0;i<e.length;i++){if(e[i]+1<t.legalSizes[i].length){e[i]++;break}if(i==e.length-1&&e[i]+1==t.legalSizes[i].length){for(let r=0;r<e.length;r++)e[r]=0;break}e[i]=0}}while(e.some(n=>n!=0))}function*q(t,e){const n=[];for(const[i,r]of t.entries())for(let o=0;o<r;o++)n.push(i);const s=new v(n);for(;s.hasNext();){const i=[];for(let o=0;o<t.length;o++)i.push([]);const r=s.next();for(const[o,u]of r.entries())i[u].push(e[o]);yield i}}function I(t,e,n){const s=[0,...e.courses[0].choices.map(a)];for(const[r,o]of t.entries())for(const u of o){const p=e.people[u].choices.indexOf(r);if(p>=0){s[p]++;continue}s[s.length-1]++}const i=s.reduce(h,0)/n;return{gotChoice:s,avg:i}}function N(t,e){return t.avg-e.avg}function z(t,e){for(let n=0;n<t.gotChoice.length;n++){if(t.gotChoice[n]>e.gotChoice[n])return-1;if(e.gotChoice[n]>t.gotChoice[n])return 1}return 0}function b(t,e){for(let n=t.gotChoice.length-1;n>=0;n--){if(t.gotChoice[n]<e.gotChoice[n])return-1;if(e.gotChoice[n]<t.gotChoice[n])return 1}return 0}function M(t,e,n){for(const[s,i]of t.entries())if(i.assigned)for(const r of e)r.courseAssignments[s].push(...i.assigned),r.quality.gotChoice[0]+=i.assigned.length;for(const s of e)s.quality.avg=s.quality.gotChoice.reduce(h,0)/n;return e}function a(){return 0}function T(t,e){return t.map((n,s)=>e[s][n])}function O(t,e){return t+e}function h(t,e,n){return t+e*n}function j(t,e){t.splice(e,1)}function g(t,e){const n=[];for(let s=t;s<e;s++)n.push(s);return n}return self.document||(self.onmessage=t=>{const e=t.data,n=f(e);postMessage({type:0,result:n})}),c.default=f,c.mapToZero=a,Object.defineProperty(c,"__esModule",{value:!0}),c})({});})();
